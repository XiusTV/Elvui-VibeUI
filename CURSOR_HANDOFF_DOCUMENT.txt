========================================
ELVUI FIXES - CURSOR AGENT HANDOFF
========================================
Date: November 5, 2025
Project: ElvUI VibeUI - Ascension WoW (Bronzebeard Realm)
Workspace: E:\Games\Ascension\Live\Interface

========================================
CONTEXT - WHAT WE WERE FIXING
========================================

User reported 3 main issues:
1. AuraTracker not showing countdown timers on action bar buttons
2. ButtonFacade hiding reagent/stack counts when enabled
3. ElvUI search function crashing

Also requested:
4. Menu order: Put General below Search (not alphabetical)

========================================
CURRENT STATUS - WHAT'S FIXED
========================================

‚úÖ 1. AURATRACKER SYNTAX ERROR (Line 63) - FIXED
   File: AddOns/ElvUI/Modules/ActionBars/AuraTracker.lua
   - Changed button:GetAttribute to button.GetAttribute
   
‚úÖ 2. SEARCH FUNCTION CRASH - FIXED
   File: AddOns/ElvUI_OptionsUI/Search.lua
   - Added type check for values before iterating (line 210)
   
‚úÖ 3. BUTTONFACADE DISABLE ERROR - FIXED
   File: AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua
   - Changed DeleteButton to RemoveButton (correct API)
   - Removed LBF:DeleteGroup calls
   
‚úÖ 4. BUTTONFACADE RELOAD POPUP - ADDED
   File: AddOns/ElvUI_OptionsUI/ButtonFacade.lua
   - Added reload popup when enabling/disabling ButtonFacade
   - Added reload popup when changing skins
   
‚úÖ 5. GENERAL MENU ORDER - CHANGED
   File: AddOns/ElvUI_OptionsUI/General.lua
   - Changed order from 60 to 2 (now below Search)

========================================
CURRENT STATUS - WHAT'S IN PROGRESS
========================================

üîß 6. AURATRACKER COUNTDOWN NOT SHOWING - IN TESTING

Latest fixes applied (need user to test):

File: AddOns/ElvUI/Modules/ActionBars/AuraTracker.lua

Issues identified:
- auraText wasn't being created (Button1 has no auraText!)
- Text parented to button didn't render (only UIParent worked)
- Caster was nil on Ascension (broken detection)
- Spell ranks didn't match (Moonfire(Rank 10) vs Moonfire)
- Negative timestamps (-189604s - broken time calculation)

Fixes applied:
a) Lines 207-240: Create auraText in RegisterButton(), not UpdateButtonDuration()
   - Creates frame parented to UIParent at TOOLTIP strata
   - Ensures text always exists and is visible
   
b) Lines 25-37: Strip rank from spell names on action bars
   - "Moonfire(Rank 10)" ‚Üí "Moonfire"
   
c) Lines 138-140, 164-166: Strip rank from aura names on target
   - Matches stripped spell names
   
d) Lines 143-144, 169-170: Treat nil caster as "yours"
   - Ascension workaround: (caster == nil) means it's yours
   
e) Lines 150, 176: Time validation
   - Only accept positive times < 1 day (86400s)
   - Filters out the -189604s bug

Status: User needs to /reload and test with /debugspells


üîß 7. BUTTONFACADE REAGENT COUNTS - IN PROGRESS

Issue: Counts show when ButtonFacade disabled, hidden when enabled

Fixes applied:

File: AddOns/ElvUI/Modules/ActionBars/ActionBars.lua

a) Line 799: Set hideElements.count = false
   - Tells LAB not to hide count element
   
b) Line 550: Explicit count:Show() in StyleButton
   - Initial visibility
   
c) Lines 874-885: Count fix in LAB_ButtonUpdate callback
   - Checks if count Width/Height is 0
   - Restores to 36x10 if needed
   - Runs on EVERY button update (same as hotkeys)
   - Forces Show() and SetAlpha(1)

File: AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua

d) Lines 16-47: Added FixButtonCount() helper and BF:FixAllCounts()
   - Centralized count fixing logic
   
e) Lines 212-220: Delayed fix after skinning (0.1s)
   - Fixes counts after LBF applies skin
   
f) Lines 133-135: Additional delayed fix (0.2s)
   - Secondary safety fix in UpdateSkins()

Status: User needs to enable ButtonFacade and test

========================================
FILES MODIFIED - COMPLETE LIST
========================================

Core Functionality:
1. AddOns/ElvUI/Modules/ActionBars/AuraTracker.lua (408 lines)
2. AddOns/ElvUI/Modules/ActionBars/ActionBars.lua (1031 lines)
3. AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua (358 lines)
4. AddOns/ElvUI_OptionsUI/ButtonFacade.lua (399 lines)
5. AddOns/ElvUI_OptionsUI/Search.lua (228 lines)
6. AddOns/ElvUI_OptionsUI/General.lua (order changed to 2)

Debug/Testing:
7. AddOns/ElvUI/Modules/ActionBars/DebugHelper.lua (NEW - 387 lines)
8. AddOns/ElvUI/Modules/ActionBars/Load_ActionBars.xml (loads DebugHelper)

Documentation:
9. AddOns/ElvUI/FIXES_README.txt
10. AddOns/ElvUI/CRITICAL_FIXES_SUMMARY.txt
11. AddOns/ElvUI/AURATRACKER_AND_BF_FIXES.txt
12. AddOns/ElvUI/AURATRACKER_FINAL_FIX.txt
13. AddOns/ElvUI/BUTTONFACADE_COUNT_FINAL_FIX.txt
14. AddOns/ElvUI/DEBUG_NEXT_STEPS.txt

========================================
DEBUG COMMANDS AVAILABLE
========================================

/debugab
  Shows full diagnostic of ActionBars and AuraTracker
  - Module status, initialization, settings
  - Button counts, visibility
  
/fixcount
  Force count display on all buttons
  - Uses ButtonFacade fix if available
  - Restores Width/Height from 0
  
/testautrack
  Test AuraTracker with visual test
  - Shows auraText status
  - Forces "TEST 99" (magenta) on button (parented to button)
  - Forces "UI 99" (yellow) on button (parented to UIParent)
  - Use to test which parenting method works
  - Prevents text clearing during test (__testMode flag)
  
/cleartest
  Clear test mode from Button1
  - Removes __testMode flag
  - Clears test text
  
/debugspells
  Show spell-to-aura matching (MOST IMPORTANT!)
  - Lists all spells on action bars
  - Lists all auras on current target
  - Shows which ones MATCH
  - Strips ranks for proper matching
  - Shows "ON Bar1 Button3" for matches
  - Says "MATCHES FOUND!" or "NO MATCHES!"

========================================
TESTING STATUS - WHAT USER HAS DONE
========================================

Last test results (via /debugspells):

Target: Dynamic Training Dummy
Debuffs on target:
  1. Moonfire [-189604s] Mine:nil
  2. Faerie Fire [-189316s] Mine:nil
  
Result: NO MATCHES!

Issues found from testing:
1. Mine:nil (caster is nil) - NOW FIXED (treats nil as yours)
2. Negative time - NOW FIXED (validates time is positive)
3. No matches - NOW FIXED (strips ranks from both sides)
4. auraText exists but text doesn't render when parented to button
   - NOW FIXED (parented to UIParent frame)

Visual test results:
- "UI 99" (yellow, UIParent) - VISIBLE ‚úÖ
- "TEST 99" (magenta, button) - NOT VISIBLE ‚ùå
- Proves: Only UIParent parenting works

========================================
NEXT STEPS FOR TESTING
========================================

CRITICAL: User needs to /reload and test again!

Test 1: AuraTracker with /debugspells
--------------------------------------
1. /reload
2. Target training dummy
3. Cast Moonfire (or any debuff from your bars)
4. /debugspells

Expected output NOW:
  Spell Names on Action Bars:
    Bar1 Button X: Moonfire(Rank 14) ‚Üí Moonfire
  
  Debuffs:
    1. Moonfire [15s] Mine:true ON Bar1 ButtonX ‚úÖ
  
  MATCHES FOUND!

5. LOOK AT THAT BUTTON - should see countdown!

If still not working:
- Run /testautrack to verify auraText exists
- Check if text shows at all
- Report back what /debugspells says


Test 2: ButtonFacade Reagents
------------------------------
1. Enable ButtonFacade: /elvui ‚Üí ActionBars ‚Üí LBF Support
2. Choose any skin
3. Accept reload popup
4. Put potions/food on bars (items with stack counts)
5. Look for numbers on buttons

Expected: Numbers should be visible

If not showing:
- Try /fixcount
- Run /debugab
- Check if LAB_ButtonUpdate is being called


Test 3: Menu Order
------------------
1. Open /elvui
2. General should be 2nd option (below Search)

Expected: General appears right after Search

========================================
KNOWN ISSUES / ASCENSION-SPECIFIC
========================================

1. Caster returns nil on Ascension
   - Workaround: Treat nil caster as "yours"
   - Code: (caster and UnitIsUnit(caster, "player")) or (caster == nil)

2. ExpirationTime can be negative
   - Workaround: Validate time is positive and < 1 day
   - Code: if timeLeft > 0 and timeLeft < 86400 then

3. RaidFrame taint warning
   - "ElvUI prevented secure function RaidFrame:Hide()"
   - This is normal ElvUI behavior, not our bug
   - Doesn't affect functionality

4. Target name shows "nil" suffix
   - "Dynamic Training Dummy nil"
   - Cosmetic issue, doesn't affect tracking

========================================
AURATRACKER SETTINGS
========================================

Location: /elvui ‚Üí ActionBars ‚Üí AuraTracker

Default settings:
- enable: true
- onlyPlayer: true (only show YOUR auras)
  ** If testing, try setting to FALSE to see all auras **
- font: "PT Sans Narrow"
- fontSize: 18
- fontOutline: "OUTLINE"
- colorByTime: true
  - Red < 5s
  - Yellow < 10s
  - Green > 10s

========================================
BUTTONFACADE SETTINGS
========================================

Location: /elvui ‚Üí ActionBars ‚Üí Action Bars ‚Üí LBF Support

Settings:
- Enable: Toggle on/off (shows reload popup)
- Skin: Choose from 30+ skins
- Gloss: 0-1 intensity
- Backdrop: Show/hide backdrop

Problematic skins (Width=0, Height=0 for Count):
- Aquatic I, II, III
- pHish, pHish2, SmartName
- Random1, Random2, Random3

Good skins:
- ElvUI (default)
- Nefs, Divinity, PixelSkin, Shadow, etc.

========================================
KEY CODE SECTIONS
========================================

AuraTracker RegisterButton (creates auraText):
Lines 207-240 in AuraTracker.lua
- Creates textFrame parented to UIParent
- Creates auraText FontString
- Sets TOOLTIP strata, level 100
- Positions over button

AuraTracker UpdateButtonDuration (updates text):
Lines 109-198 in AuraTracker.lua
- Gets spell name from button
- Checks target for matching aura
- Strips ranks for matching
- Validates caster (nil = yours)
- Validates time (positive, < 1 day)
- Updates text with countdown

LAB_ButtonUpdate (fixes counts):
Lines 871-906 in ActionBars.lua
- Called on every button update
- Checks count Width/Height
- Restores from 0 to 36x10
- Forces Show() and SetAlpha(1)

ButtonFacade RegisterAndSkinBar:
Lines 139-221 in ButtonFacade.lua
- Registers buttons with LBF
- Applies skin
- Delayed count fix (0.1s)

========================================
TESTING CHECKLIST FOR NEXT SESSION
========================================

[ ] 1. /reload and verify no errors
[ ] 2. /elvui - confirm General is 2nd in menu
[ ] 3. /debugspells with Moonfire on target
      - Should show "MATCHES FOUND!"
      - Note what it says exactly
[ ] 4. Look at Moonfire button - see countdown?
      - If YES: AuraTracker works! ‚úÖ
      - If NO: Report /debugspells output
[ ] 5. Enable ButtonFacade with any skin
      - Reload popup should appear
[ ] 6. Check reagent counts on buttons
      - If YES: ButtonFacade works! ‚úÖ
      - If NO: Try /fixcount
[ ] 7. Test different ButtonFacade skins
      - Try Aquatic I (known problem skin)
      - Counts should still show
[ ] 8. Test AuraTracker with buffs
      - Target yourself
      - Cast Gift of the Wild, Thorns, etc.
      - Check if countdowns appear

========================================
IF AURATRACKER STILL NOT WORKING
========================================

Diagnostic steps:

1. Run /testautrack
   - Check "Text after force" - should say "TEST 99"
   - Look at Button1 for yellow "UI 99"
   - If you see yellow but not magenta, parenting works

2. Run /debugspells
   - Check if it says "MATCHES FOUND!"
   - Note which button the match is on
   - Look at that specific button

3. Check settings:
   - /elvui ‚Üí ActionBars ‚Üí AuraTracker
   - Try setting onlyPlayer = false
   - This will show ALL auras, not just yours

4. Possible issues:
   a) Text renders but you can't see it
      - Check button size/scale
      - Text might be too small or wrong color
   
   b) Matches not found
      - Spell name mismatch
      - Check /debugspells output for exact names
   
   c) Time still broken
      - Check if times are positive
      - Negative times won't show

========================================
IF BUTTONFACADE COUNTS STILL HIDDEN
========================================

Diagnostic steps:

1. Disable ButtonFacade
   - Counts should appear immediately
   - If YES: ButtonFacade is the issue
   
2. Enable ButtonFacade
   - Try "ElvUI" skin first (known good)
   - Then try "Aquatic I" (known bad)
   
3. Run /fixcount
   - Forces count fix NOW
   - Check if counts appear
   
4. Run /debugab
   - Shows if LAB is enabled
   - Shows button status

5. Check LAB_ButtonUpdate:
   - This callback should run on every update
   - Fixes count Width/Height
   - If not working, callback might not be firing

========================================
CODE ARCHITECTURE NOTES
========================================

AuraTracker Flow:
1. Module loads ‚Üí Initialize() called
2. Waits for ActionBars ready
3. RegisterAllButtons() called after 0.5s
4. Each button gets auraText created (RegisterButton)
5. Events registered: UNIT_AURA, PLAYER_TARGET_CHANGED
6. OnUpdate timer runs 10x/second
7. UpdateButtonDuration() checks for matching auras
8. Text updated with countdown

ButtonFacade Count Fix Flow:
1. StyleButton() sets count:Show() (initial)
2. ButtonFacade applies skin (may set Width=0)
3. Delayed fix after 0.1s (RegisterAndSkinBar)
4. LAB_ButtonUpdate() called on every button update
5. Checks Width/Height, restores if 0
6. This keeps counts visible continuously

Why Multiple Fixes Needed:
- Different systems can hide the count at different times
- Need to fix at initialization, after skinning, and on updates
- Similar to defensive programming

========================================
IMPORTANT ASCENSION-SPECIFIC QUIRKS
========================================

1. UnitAura caster parameter returns nil
   - Standard WoW: returns "player", "target", etc.
   - Ascension: returns nil even for your own auras
   - Workaround: Assume nil = yours

2. ExpirationTime can be negative
   - Should be GetTime() + duration
   - Ascension sometimes returns negative values
   - Workaround: Validate timeLeft > 0

3. Spell ranks in names
   - All spells show rank: "Moonfire(Rank 14)"
   - Auras may or may not have rank
   - Workaround: Strip ranks from both sides

========================================
POTENTIAL FUTURE ISSUES
========================================

If AuraTracker works but has problems:

1. Text overlaps with other elements
   - Adjust position in RegisterButton (line 219)
   - Current: TOP, 0, 0 (covers whole button)
   - Could change to specific position

2. Text too large/small
   - Adjust fontSize in settings
   - Default: 18

3. onlyPlayer filter too strict
   - Try disabling it
   - Will show all auras on target

4. Performance issues
   - OnUpdate runs 10x/second
   - Could reduce to 5x/second (change 0.1 to 0.2)
   - Line 265 in AuraTracker.lua

========================================
BUTTONFACE COUNT ISSUES - IF PERSIST
========================================

If LAB_ButtonUpdate fix doesn't work:

1. Check if callback is registered
   - Line 907: LAB.RegisterCallback(AB, "OnButtonUpdate", AB.LAB_ButtonUpdate)
   - Might need to verify LAB exists

2. Try different approach:
   - Hook button:SetCount() function
   - Force size after every SetCount call

3. Check specific skins:
   - Some skins might have additional hiding mechanisms
   - Try ElvUI skin specifically

4. Last resort:
   - Modify skin definitions to not set Width=0
   - Edit Skins.lua for problematic skins

========================================
ALTERNATIVE APPROACHES (IF NEEDED)
========================================

For AuraTracker:
- Could create separate frame overlay instead of per-button
- Could use WeakAuras-style approach
- Could hook into existing cooldown text system

For ButtonFacade Counts:
- Could completely disable LBF count skinning
- Could override skin definitions
- Could force-unhook LBF from count elements

========================================
USER FEEDBACK SO FAR
========================================

Issues reported:
1. "not showing countdown on buttons" ‚úì Diagnosed
2. "reagents not showing with ButtonFacade" ‚úì Fixed (needs testing)
3. "search crashes on unitframe" ‚úì Fixed
4. "blank bars when enabling ButtonFacade" ‚úì Fixed (reload popup)

Visual confirmations:
- Saw yellow "UI 99" text (proves UIParent rendering works)
- Did NOT see magenta "TEST 99" (proves button parenting broken)
- Reagent counts DO show with ButtonFacade disabled
- /debugspells showed NO MATCHES (but we fixed the bugs causing it)

========================================
WHAT TO TELL NEXT AGENT
========================================

"We fixed multiple issues with ElvUI AuraTracker and ButtonFacade:

1. AuraTracker had syntax errors, parenting issues, and Ascension-specific
   bugs (nil caster, negative time, rank matching). All fixed.
   
2. ButtonFacade was hiding reagent counts because skins set Width=0.
   Fixed by adding count restoration to LAB_ButtonUpdate callback.
   
3. Search crashed on table iteration. Fixed with type check.

4. Added reload popup for ButtonFacade changes.

5. Moved General to order=2 in menu.

User needs to test:
- /reload
- /debugspells (should show MATCHES FOUND!)
- Look for countdown timers on matching spell buttons
- Enable ButtonFacade and check reagent counts

All files modified and debug commands are documented above.
Check /debugspells output to see if matching works now."

========================================
FILES TO CHECK IF ISSUES PERSIST
========================================

If AuraTracker still broken:
1. AddOns/ElvUI/Modules/ActionBars/AuraTracker.lua (main logic)
2. AddOns/ElvUI/Settings/Profile.lua (default settings)
3. Check if module is loaded: E:GetModule('AuraTracker', true)

If ButtonFacade counts broken:
1. AddOns/ElvUI/Modules/ActionBars/ActionBars.lua (LAB_ButtonUpdate)
2. AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua (FixAllCounts)
3. Check if LBF is loaded: E.Libs.LBF

If search still broken:
1. AddOns/ElvUI_OptionsUI/Search.lua (line 210)

========================================
RECENT CHAT HISTORY SUMMARY
========================================

Session progression:
1. Fixed AuraTracker syntax error (line 63)
2. Fixed search crash
3. Added count:Show() to StyleButton
4. Fixed ButtonFacade DeleteButton error
5. Added ButtonFacade reload popup
6. Enhanced debug commands
7. Found auraText not being created - moved to RegisterButton
8. Found button parenting doesn't render - changed to UIParent
9. Found caster nil issue - treat nil as yours
10. Found rank mismatch - strip ranks from both
11. Found time negative - validate time is positive
12. Added count fix to LAB_ButtonUpdate (like hotkeys)
13. Changed General menu order to 2

User is about to test latest fixes on another PC.

========================================
CRITICAL REMINDERS
========================================

‚ö†Ô∏è User MUST /reload before testing!
‚ö†Ô∏è Old test results are from BEFORE latest fixes!
‚ö†Ô∏è /debugspells is the KEY diagnostic command!
‚ö†Ô∏è LAB_ButtonUpdate fix is the key for ButtonFacade counts!
‚ö†Ô∏è UIParent parenting is the key for AuraTracker text!

========================================
SUCCESS CRITERIA
========================================

AuraTracker working means:
‚úì /debugspells shows "MATCHES FOUND!"
‚úì Countdown timers visible on matching spell buttons
‚úì Timers count down in real-time
‚úì Colors change (green ‚Üí yellow ‚Üí red)
‚úì Updates when auras refresh/expire

ButtonFacade working means:
‚úì Reagent counts visible with BF enabled
‚úì Stack counts visible (potions, food)
‚úì Counts update when using items
‚úì Works with ALL skins (not just ElvUI)
‚úì No reload needed for changes (popup helps)

========================================
FINAL NOTES
========================================

This was a complex debugging session involving:
- Syntax errors (: vs . for method checks)
- Rendering issues (parenting to UIParent)
- Platform-specific bugs (Ascension nil caster)
- LibButtonFacade skinning conflicts
- String matching (rank stripping)
- Time calculation issues
- Event/callback timing

All critical fixes are in place. User needs to test
with /reload and /debugspells to confirm they work.

If issues persist, the /debug commands will reveal
exactly what's still wrong.

========================================
END OF HANDOFF DOCUMENT
========================================

Transfer this document to the other PC and show it
to the next Cursor agent. They will understand the
complete context and can continue from here.

Good luck with testing!
========================================

