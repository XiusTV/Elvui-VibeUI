========================================
ElvUI CRITICAL FIXES - November 2025
========================================

ALL ISSUES FIXED:
-----------------

✅ 1. AURATRACKER SYNTAX ERROR (Line 63)
✅ 2. SEARCH FUNCTION BROKEN (unitframe search)
✅ 3. BUTTONFACADE COUNT NOT SHOWING (reagents/stacks hidden)
✅ 4. BUTTONFACADE DISABLE ERROR (DeleteButton crash)

========================================

ISSUE #1: AURATRACKER SYNTAX ERROR
-----------------------------------
File: AddOns/ElvUI/Modules/ActionBars/AuraTracker.lua
Line: 63

Error Message:
"function arguments expected near 'and'"

Problem:
Used button:GetAttribute (method call) instead of button.GetAttribute (property check)

Fix:
Changed : to . for existence checking

Status: ✅ FIXED

========================================

ISSUE #2: SEARCH FUNCTION BROKEN
---------------------------------
File: AddOns/ElvUI_OptionsUI/Search.lua
Line: 211

Error Message:
"bad argument #1 to '(for generator)' (table expected, got string)"

Problem:
Code tried to iterate over 'values' which could be a string, not just a table.
The search function crashed when encountering string values instead of tables.

Fix:
Added type check: if values and type(values) == 'table' then

Status: ✅ FIXED

========================================

ISSUE #3: BUTTONFACADE COUNT NOT SHOWING
-----------------------------------------
Files: 
- AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua
- AddOns/ElvUI/Modules/ActionBars/ActionBars.lua

Problem:
Many ButtonFacade skins set Count element to Width=0, Height=0
This completely hides:
- Reagent counts (Soul Shards, arrows, bullets)
- Item stack counts (potions, food, bandages)
- Ability charges (multi-charge spells)

Affected Skins:
- Aquatic I, II, III
- pHish, pHish2
- SmartName
- Random1, Random2, Random3

Fixes Applied:
1. Created FixButtonCount() helper function
2. Created BF:FixAllCounts() to fix all buttons
3. Added delayed count fix (0.1s after skin applies)
4. Added delayed fix in UpdateSkins() (0.2s)
5. Updated /fixcount command to use new system

How It Works:
After ButtonFacade applies a skin, we wait 0.1-0.2 seconds,
then check all Count elements. If Width or Height is 0,
we restore them to 36x10 pixels and force Show().

Status: ✅ FIXED

========================================

ISSUE #4: BUTTONFACADE DISABLE ERROR
-------------------------------------
File: AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua
Lines: 217, 235

Error Message:
"attempt to call method 'DeleteButton' (a nil value)"

Problem:
Code tried to call group:DeleteButton() which doesn't exist
in LibButtonFacade API. The correct method is RemoveButton().

Also tried to call LBF:DeleteGroup() which also doesn't exist.

Fix:
1. Changed DeleteButton() to RemoveButton()
2. Removed LBF:DeleteGroup() calls (not needed)
3. Added safety check: if group and group.RemoveButton then

Status: ✅ FIXED

========================================

HOW TO TEST:
------------

1. /reload or /reloadui

2. Test Search:
   - Open /elvui
   - Click search box
   - Type "unitframe"
   - Should work without errors

3. Test Count Display (WITH ButtonFacade enabled):
   - Enable ButtonFacade: /elvui → ActionBars → LBF Support → Enable
   - Pick any skin (try Aquatic I or pHish)
   - Put items with counts on action bars (potions, food)
   - Numbers should appear after ~0.2 seconds
   - Try /fixcount if they don't appear immediately

4. Test ButtonFacade Disable:
   - /elvui → ActionBars → LBF Support → Disable
   - /reload
   - Should not crash
   - Counts should show correctly

5. Test AuraTracker:
   - /elvui → ActionBars → AuraTracker → Enable
   - Target a mob
   - Cast a DoT/buff
   - Duration should appear on that spell's button

========================================

DEBUG COMMANDS:
---------------

/debugab       - Shows detailed status of all systems
/fixcount      - Force count display fix NOW
/testautrack   - Test AuraTracker manually

========================================

TECHNICAL DETAILS:
------------------

ButtonFacade Count Fix Strategy:
1. LBF applies skin synchronously
2. Skin sets Count Width/Height to 0
3. We wait 0.1s using E:Delay()
4. Check if Width or Height is 0
5. Restore to 36x10 if needed
6. Force Show() and SetAlpha(1)
7. Additional 0.2s delayed fix in UpdateSkins()

Why Delays Are Needed:
LibButtonFacade applies skins in multiple passes.
Sometimes the Count element is resized after our
initial fix. The delays ensure LBF is completely
finished before we restore the count size.

Search Fix:
The search code assumed all values were tables.
Some ElvUI options return strings instead.
Added type() check before iteration.

========================================

FILES MODIFIED:
---------------

1. AddOns/ElvUI/Modules/ActionBars/AuraTracker.lua
   - Line 63: Fixed GetAttribute check

2. AddOns/ElvUI_OptionsUI/Search.lua
   - Line 210: Added type check for table

3. AddOns/ElvUI/Modules/ButtonFacade/ButtonFacade.lua
   - Lines 16-34: Added FixButtonCount() helper
   - Lines 36-47: Added BF:FixAllCounts()
   - Lines 133-135: Added delayed fix in UpdateSkins()
   - Lines 212-220: Added delayed fix in RegisterAndSkinBar()
   - Lines 217, 235: Changed DeleteButton to RemoveButton

4. AddOns/ElvUI/Modules/ActionBars/ActionBars.lua
   - Line 550: Explicit count:Show()
   - Line 799: Set hideElements.count = false

5. AddOns/ElvUI/Modules/ActionBars/DebugHelper.lua
   - Lines 80-125: Updated /fixcount command

6. AddOns/ElvUI/Modules/ActionBars/Load_ActionBars.xml
   - Line 9: Loads DebugHelper.lua

========================================

KNOWN WORKING CONFIGURATIONS:
------------------------------

✅ ButtonFacade DISABLED
   - Counts show immediately
   - No errors

✅ ButtonFacade ENABLED with "ElvUI" skin
   - Counts show (skin has correct settings)
   - No errors

✅ ButtonFacade ENABLED with any other skin
   - Counts show after 0.2 second delay
   - Use /fixcount if delay is too long
   - No errors

✅ Enabling/Disabling ButtonFacade
   - No crashes
   - Counts always visible after reload

✅ Search function
   - All searches work
   - No table/string errors

========================================

TROUBLESHOOTING:
----------------

Q: Counts still don't show with ButtonFacade?
A: 
1. Wait 0.2 seconds after /reload
2. Try /fixcount command
3. Check /debugab output
4. Try switching to "ElvUI" skin
5. Disable ButtonFacade temporarily

Q: Error when disabling ButtonFacade?
A: Make sure you /reload after accepting changes

Q: Search still crashes?
A: Make sure you reloaded after the fix

Q: AuraTracker not working?
A: Run /testautrack to diagnose

========================================

SUCCESS INDICATORS:
-------------------

After /reload, you should see:
- No error messages in chat
- Item counts visible on buttons (with or without BF)
- Search works in /elvui
- Can enable/disable ButtonFacade without errors
- AuraTracker shows durations (if enabled)

All systems should be fully functional!

========================================

